<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resource Pack Builder | Skythoria Tools</title>
  <style>
    @font-face {
      font-family: 'Minecraft';
      src: url('/assets/MinecraftRegular.woff') format('woff');
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #111;
      color: #EEE;
      margin: 0;
    }
    .nav {
      background: #1b1b1b;
      padding: 10px 20px;
      text-align: center;
      border-bottom: 2px solid #FF3B3F;
    }
    .nav a {
      color: #FF3B3F;
      text-decoration: none;
      margin: 0 15px;
      font-weight: bold;
    }
    .nav a:hover {
      text-decoration: underline;
    }
    header, section {
      max-width: 1000px;
      margin: 20px auto;
      padding: 20px;
      background: #222;
      border-radius: 8px;
    }
    h1, h2 {
      color: #FF3B3F;
      font-family: 'Minecraft', monospace;
      margin-top: 0;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }
    input[type="text"], input[type="file"] {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      background: #2d2d2d;
      color: #EEE;
      border: 1px solid #444;
      border-radius: 4px;
    }
    button, .copy-btn {
      margin-top: 15px;
      padding: 10px 20px;
      background: #FF3B3F;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 1em;
      cursor: pointer;
    }
    .copy-btn {
      display: inline-block;
      margin-left: 10px;
      vertical-align: middle;
    }
    button:hover, .copy-btn:hover {
      background: #e03335;
    }
    .item-block {
      border: 1px solid #333;
      padding: 15px;
      margin-top: 20px;
      background: #1a1a1a;
      border-radius: 6px;
    }
    .give-preview {
      font-family: monospace;
      color: #0f0;
      background: #2d2d2d;
      padding: 5px;
      display: block;
      border-radius: 4px;
      margin-top: 5px;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <div class="nav">
    <a href="/">Home</a>
    <a href="/tools/index.html">Tools</a>
    <a href="https://discord.gg/NCtM5fMY" target="_blank">Discord</a>
  </div>

  <section>
    <h1>Resource Pack Builder</h1>
    <p>This tool takes <strong>Blockbench model (.json)</strong> and <strong>texture (.png)</strong> and outputs a working Minecraft 1.21.6+ resource pack using <code>pack_format: 63</code> with <code>custom_model_data</code> (string-based).</p>
    <ul>
      <li>Create models using <a href="https://blockbench.net/" target="_blank">Blockbench</a> (Java format)</li>
      <li>Export the model JSON and texture PNG</li>
      <li>Fill out the base item and model ID per entry</li>
      <li>Download the final ZIP pack and place in your <code>.minecraft/resourcepacks</code> folder</li>
    </ul>

    <label>Resource Pack Name:</label>
    <input type="text" id="packName" placeholder="Example: SkythoriaPack">

    <div id="itemsContainer"></div>

    <button onclick="addItem()">Add Item</button>
    <button id="generatePack">Generate Resource Pack</button>

    <div style="margin-top:20px;">
      <a id="downloadLink" class="button" style="display:none;">Download Pack</a>
    </div>
  </section>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    let itemCount = 0;
    function addItem() {
      itemCount++;
      const div = document.createElement("div");
      div.className = "item-block";
      div.innerHTML = `
        <label>Item #${itemCount}</label>
        <label>Custom Model ID (string):</label>
        <input type="text" class="id">
        <label>Base Item:</label>
        <input type="text" class="base">
        <label>Model JSON:</label>
        <input type="file" class="model" accept=".json">
        <label>Texture PNG:</label>
        <input type="file" class="texture" accept=".png">
        <label>Give Command:</label>
        <span class="give-preview"></span>
      `;
      document.getElementById('itemsContainer').appendChild(div);

      const update = () => {
        const base = div.querySelector('.base').value.trim();
        const id = div.querySelector('.id').value.trim();
        const out = div.querySelector('.give-preview');
        out.textContent = base && id ? `/give @p ${base}[minecraft:custom_model_data={strings:["${id}"]}]` : '';
      };
      div.querySelector('.base').addEventListener('input', update);
      div.querySelector('.id').addEventListener('input', update);
    }

    document.getElementById('generatePack').addEventListener('click', async () => {
      const zip = new JSZip();
      const packName = document.getElementById('packName').value.trim();
      if (!packName) return alert("Enter pack name!");

      zip.file("pack.mcmeta", JSON.stringify({
        pack: { pack_format: 63, description: packName }
      }, null, 2));

      const selectors = {}; // baseItem â†’ list of cases
      const reads = [];

      for (const block of document.querySelectorAll('.item-block')) {
        const id = block.querySelector('.id').value.trim();
        const base = block.querySelector('.base').value.trim();
        const modelFile = block.querySelector('.model').files[0];
        const textureFile = block.querySelector('.texture').files[0];
        if (!id || !base || !modelFile || !textureFile) continue;

        const modelPath = `assets/minecraft/models/item/${id}.json`;
        const texturePath = `assets/minecraft/textures/item/${id}.png`;
        const selectorPath = `assets/minecraft/items/${base}.json`;

        const modelReader = new FileReader();
        const textureReader = new FileReader();

        reads.push(new Promise((res) => {
          modelReader.onload = () => {
            let modelData = JSON.parse(modelReader.result);
            modelData.textures = { layer0: `item/${id}` };
            zip.file(modelPath, JSON.stringify(modelData, null, 2));
            res();
          };
          modelReader.readAsText(modelFile);
        }));

        reads.push(new Promise((res) => {
          textureReader.onload = () => {
            zip.file(texturePath, textureReader.result);
            res();
          };
          textureReader.readAsArrayBuffer(textureFile);
        }));

        if (!selectors[base]) selectors[base] = [];
        selectors[base].push({ when: id, model: { type: "model", model: `item/${id}` } });
      }

      await Promise.all(reads);

      for (const [base, cases] of Object.entries(selectors)) {
        const selectorJson = {
          model: {
            type: "select",
            property: "custom_model_data",
            fallback: { type: "model", model: `item/${base}` },
            cases: cases
          }
        };
        zip.file(`assets/minecraft/items/${base}.json`, JSON.stringify(selectorJson, null, 2));
      }

      const blob = await zip.generateAsync({ type: "blob" });
      const link = document.getElementById('downloadLink');
      link.href = URL.createObjectURL(blob);
      link.download = `${packName}.zip`;
      link.style.display = "inline-block";
      link.textContent = `Download ${packName}.zip`;
    });

    // Add default 1 item row
    addItem();
  </script>
</body>
</html>
